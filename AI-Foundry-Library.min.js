const foundry={textToText:async function({inputKey:e,model:t="hermes-2-pro-llama-3-8b",userPrompt:n,systemPrompt:r,temperature:i=.9,maxTokens:a=250,noLogging:o=!1,rememberMessages:s=0,loadingIndicatorId:l,resultElementId:u}){if(!e){console.error("No API key provided.");return}if(o||console.log("Running text-to-text function"),s){o||console.log("Chat history is active.");messages=[{role:"system",content:r},{role:"user",content:`React to the message based on this message history: ${JSON.stringify(foundry.messageHistory)}. Latest message: ${n}`},]}else messages=[{role:"system",content:r},{role:"user",content:n},];try{l&&document.getElementById(l).setAttribute("aria-busy","true");let c=await fetch("https://data.id.tue.nl/v1/chat/completions",{method:"POST",cache:"no-cache",redirect:"manual",headers:{"Content-Type":"application/json","User-Agent":"curl/8.7.1",Authorization:`Bearer ${e}`},referrerPolicy:"no-referrer",body:JSON.stringify({key:"value",api_token:e,task:"chat",messages:messages,model:t,temperature:i,max_tokens:a})}),d=await c.json(),g=d.choices[0].message.content;return o||console.log("Result:",g),u&&(document.getElementById(u).innerHTML=g),l&&document.getElementById(l).setAttribute("aria-busy","false"),s&&(foundry.messageHistory.push({role:"user",content:n},{role:"assistant",content:g}),foundry.messageHistory.length>s&&foundry.messageHistory.splice(0,2)),g}catch(y){console.error("Error:",y)}},textToImage:async function({inputKey:e,userPrompt:t,temperature:n=.9,noLogging:r,loadingIndicatorId:i,resultElementId:a,steps:o=20,width:s=512,height:l=512}){if(r||console.log("Running text-to-image function"),!e){console.error("No API key provided.");return}try{i&&document.getElementById(i).setAttribute("aria-busy","true");let u=await fetch("https://data.id.tue.nl/v1/images/generations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({prompt:t,steps:o,width:s,height:l,temperature:n})});if(!u.ok)throw Error(`HTTP error! status: ${u.status}`);let c=await u.json();return r||console.log("Generated image:",c.image_url),a&&(document.getElementById(a).src=c.image_url),i&&document.getElementById(i).setAttribute("aria-busy","false"),c.image_url}catch(d){console.error("There was a problem with the fetch operation:",d.message)}},textToSound:function(){console.log("Text to sound is currently not supported.")},imageToText:async function({inputKey:e,model:t="llava-llama-3-8b-v1_1",userPrompt:n,systemPrompt:r,image:i,popup:a=!1,temperature:o=.9,maxTokens:s=250,noLogging:l=!1,loadingIndicatorId:u,resultElementId:c}){if(!e){console.error("No API key provided.");return}if(l||console.log("Running image-to-text function"),a){document.getElementById("df_fileInput")||(document.body.innerHTML+='<input type="file" id="df_fileInput" accept="image/*" style="display: none;" onchange=""></input>'),document.getElementById("df_fileInput").click();try{i=await new Promise((e,t)=>{let n=document.getElementById("df_fileInput");if(!n){t(Error("File input element not found"));return}n.onchange=async function(n){let r=n.target.files;if(r&&r.length>0){let a=r[0];l||console.log("File selected:",a);try{i=await p(a,l),e(i)}catch(o){t(Error("Error during image processing"))}}else t(Error("No file selected"))}})}catch(d){console.error("Error:",d.message)}}else i=await p(i);messages=[{role:"system",content:r},{role:"user",content:[{type:"text",text:n},{type:"image_url",image_url:{url:i}},]},];try{u&&document.getElementById(u).setAttribute("aria-busy","true");let g=await fetch("https://data.id.tue.nl/v1/chat/completions",{method:"POST",cache:"no-cache",redirect:"manual",headers:{"Content-Type":"application/json","User-Agent":"curl/8.7.1",Authorization:`Bearer ${e}`},referrerPolicy:"no-referrer",body:JSON.stringify({key:"value",api_token:e,task:"chat",messages:messages,model:t,temperature:o,max_tokens:s})}),y=await g.json(),m=y.choices[0].message.content;return l||console.log("Result:",m),c&&(document.getElementById(c).innerHTML=m),u&&document.getElementById(u).setAttribute("aria-busy","false"),m}catch(f){console.error("Error:",f)}function p(e){return new Promise((t,n)=>{if(e instanceof File){let r=new FileReader;r.onload=function(e){let r=new Image;r.src=e.target.result,r.onload=function(){h(r,l).then(t)},r.onerror=function(){n(Error("Error loading image from file"))}},r.onerror=function(){n(Error("Error reading the image file"))},r.readAsDataURL(e)}else if("string"==typeof e){let i=new Image;i.crossOrigin="Anonymous",i.src=e,i.onload=function(){h(i,l).then(t)},i.onerror=function(){n(Error("Error loading image from URL"))}}else n(Error("Invalid image source"))})}function h(e){return new Promise(t=>{let n=document.createElement("canvas"),r=n.getContext("2d"),i=e.width,a=e.height;i>a?i>800&&(a*=800/i,i=800):a>800&&(i*=800/a,a=800),n.width=i,n.height=a,r.drawImage(e,0,0,i,a);let o=n.toDataURL("image/jpeg",.5);l||console.log("Image processed."),t(o)})}},soundToText:async function({inputKey:e,type:t="file",sliceDuration:n=5e3,file:r,resultElementId:i,loadingIndicatorId:a,noLogging:o,stopRec:s=!1}){if(!e){console.error("No API key provided.");return}if(s)return await c();let l="";if("record"===t&&function e(t){if("undefined"!=typeof RecordRTC)o||console.log("RecordRTC is already loaded."),t();else{o||console.log("RecordRTC is not loaded, adding script to the page.");var n=document.createElement("script");n.src="https://cdn.webrtc-experiment.com/RecordRTC.js",n.async=!0,n.onload=function(){o||console.log("RecordRTC has been loaded."),t()},document.head.appendChild(n)}}(function(){navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){(recordAudio=RecordRTC(t,{type:"audio",mimeType:"audio/webm",sampleRate:44100,recorderType:StereoAudioRecorder,numberOfAudioChannels:1,desiredSampRate:16e3,timeSlice:n,disableLogs:o,ondataavailable:async function(t){l+=await d({inputKey:e,file:t}),o||console.log("Transcription:",l),i&&(document.getElementById(i).innerHTML=l)}})).startRecording()}).catch(e=>{console.error(`${e.name}: ${e.message}`)})}),"popup"===t){document.getElementById("df_audioFileInput")||(document.body.innerHTML+='<input type="file" id="df_audioFileInput" accept="audio/*" style="display: none;" onchange=""></input>'),document.getElementById("df_audioFileInput").click();try{return await d({inputKey:e,file:await new Promise((e,t)=>{let n=document.getElementById("df_audioFileInput");if(!n){t(Error("File input element not found"));return}n.onchange=async function(n){let r=n.target.files;if(r&&r.length>0){let i=r[0];o||console.log("File selected:",i);try{e(i)}catch(a){t(Error("Error during image processing"))}}else t(Error("No file selected"))}})})}catch(u){console.error("Error:",u.message)}}if("file"===t)return await d({inputKey:e,file:r});async function c(){return new Promise(t=>{recordAudio.stopRecording(async function(){let n=await d({inputKey:e,file:recordAudio.getBlob(),type:"file"});i&&(document.getElementById(i).innerHTML=n),t(n)})})}async function d({model:t="whisper-base",file:n}){let r=new FormData;r.append("model",t),r.append("file",n);try{a&&document.getElementById(a).setAttribute("aria-busy","true");let i=await fetch("https://data.id.tue.nl/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:r}),s=await i.json();return o||console.log("Result:",s.text),a&&document.getElementById(a).setAttribute("aria-busy","false"),s.text}catch(l){console.error(l.message)}}},messageHistory:[]};
