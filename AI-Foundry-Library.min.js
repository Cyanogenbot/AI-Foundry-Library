const foundry={textToText:async function({api_token:e,model:t="hermes-2-pro-llama-3-8b",server:o="https://data.id.tue.nl",prompt:r,messages:n,temperature:i=.9,max_tokens:a=500,logging:l=!0,loadingElementSelector:c,resultElementSelector:s}){if(e){l&&console.log("Running text-to-text function"),n||(r||(console.error("No prompt given. Empty message created."),r=""),n=[{role:"user",content:r}]);try{c&&(document.querySelector(c)?document.querySelector(c).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const r=await fetch(`${o}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({messages:n,model:t,temperature:i,max_tokens:a})});let d=(await r.json()).choices[0].message.content;return l&&console.log("Result:",d),s&&(document.querySelector(s).innerHTML+=d),c&&(document.querySelector(c)?document.querySelector(c).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),d}catch(e){console.error("Error:",e)}}else console.error("No API key provided.")},textToImage:async function({api_token:e,server:t="https://data.id.tue.nl",prompt:o,temperature:r=.9,logging:n=!0,loadingElementSelector:i,resultElementSelector:a,steps:l=20,width:c=512,height:s=512}){if(n&&console.log("Running text-to-image function"),e)try{i&&(document.querySelector(i)?document.querySelector(i).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const d=await fetch(`${t}/v1/images/generations`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({prompt:o,steps:l,width:c,height:s,temperature:r})});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const u=await d.json();return n&&console.log("Generated image:",u.image_url),a&&(document.querySelector(a).src=u.image_url),i&&(document.querySelector(i)?document.querySelector(i).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),u.image_url}catch(e){console.error("There was a problem with the fetch operation:",e.message)}else console.error("No API key provided.")},textToSound:async function({api_token:e,server:t="https://data.id.tue.nl",projectId:o,text:r,language:n="en",loadingElementSelector:i,resultElementSelector:a,logging:l=!0}){if(e)if(o){l&&console.log("Running text-to-sound function"),i&&(document.querySelector(i)?document.querySelector(i).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));try{const c=await fetch(`${t}/api/vendor/t2s/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_token:e,lang:n,text:r})}),s=await c.json(),d="https://data.id.tue.nl/api/vendor/t2s/"+s.text;return l&&console.log("Generated audio:",d),void 0===s.text&&console.error("No result. It is possible your API Key and project ID are not matching."),i&&(document.querySelector(i)?document.querySelector(i).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),a&&(document.querySelector(a).src=d),d}catch(e){console.error(e)}}else console.error("No project ID provided. Please find your project ID at the info section of your project.");else console.error("No API key provided.")},imageToText:async function({api_token:e,model:t="llava-llama-3-8b-v1_1",server:o="https://data.id.tue.nl",prompt:r,image:n,temperature:i=.9,max_tokens:a=500,logging:l=!0,loadingElementSelector:c,resultElementSelector:s}){if(e){n||console.error("No image provided!"),l&&console.log("Running image-to-text function"),n=await foundry.processImage(n),messages=[{role:"user",content:[{type:"text",text:r},{type:"image_url",image_url:{url:n}}]}];try{c&&(document.querySelector(c)?document.querySelector(c).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const r=await fetch(`${o}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({messages:messages,model:t,temperature:i,max_tokens:a})});let n=(await r.json()).choices[0].message.content;return l&&console.log("Result:",n),s&&(document.querySelector(s).innerHTML+=n),c&&(document.querySelector(c)?document.querySelector(c).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),n}catch(e){console.error("Error:",e)}}else console.error("No API key provided.")},soundToText:async function({api_token:e,server:t="https://data.id.tue.nl",model:o="whisper-base",type:r="file",sliceDuration:n=5e3,file:i,resultElementSelector:a,loadingElementSelector:l,logging:c=!0,stopRec:s=!1}){if(s){return await async function(){return new Promise((t=>{recordAudio.stopRecording((async function(){var r=recordAudio.getBlob();let n="";e&&(n=await u({api_token:e,model:o,file:r,type:"file"}),a&&(document.querySelector(a).innerHTML+=n)),t(n)}))}))}()}if(!e)return void console.error("No API key provided.");let d="";if("record"===r&&function(e){if("undefined"!=typeof RecordRTC)c&&console.log("RecordRTC is already loaded."),e();else{c&&console.log("RecordRTC is not loaded, adding script to the page.");var t=document.createElement("script");t.src="https://cdn.webrtc-experiment.com/RecordRTC.js",t.async=!0,t.onload=function(){c&&console.log("RecordRTC has been loaded."),e()},document.head.appendChild(t)}}((function(){navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){recordAudio=RecordRTC(t,{type:"audio",mimeType:"audio/webm",sampleRate:44100,recorderType:StereoAudioRecorder,numberOfAudioChannels:1,desiredSampRate:16e3,timeSlice:n,disableLogs:!c,ondataavailable:async function(t){d+=await u({api_token:e,model:o,file:t}),c&&console.log("Transcription:",d),a&&(document.querySelector(a).innerHTML+=d)}}),recordAudio.startRecording()})).catch((e=>{console.error(`${e.name}: ${e.message}`)}))})),"file"===r)return"string"==typeof i&&(i=await async function(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch the file: ${t.statusText}`);const o=await t.blob();return new File([o],"audio",{type:o.type})}catch(e){console.error("Error converting URL to File:",e)}}(i)),await u({api_token:e,model:o,file:i});async function u({model:o,file:r}){const n=new FormData;n.append("model",o),n.append("file",r);try{l&&(document.querySelector(l)?document.querySelector(l).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const o=await fetch(`${t}/v1/audio/transcriptions`,{method:"POST",headers:{Authorization:`Bearer ${e}`},body:n});let r;try{r=await o.json()}catch(e){console.error("An error occurred during transcription. It is possible the audio file you provided is too large.",e)}return c&&console.log("Result:",r.text),l&&(document.querySelector(l)?document.querySelector(l).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),r.text}catch(e){console.error(e.message)}}},stopRec:async function({api_token:e,server:t="https://data.id.tue.nl",logging:o=!0,loadingElementSelector:r,resultElementSelector:n}){return e?await foundry.soundToText({api_token:e,server:t,stopRec:!0,logging:o,loadingElementSelector:r,resultElementSelector:n}):await foundry.soundToText({stopRec:!0,server:t,logging:o,loadingElementSelector:r,resultElementSelector:n})},models:async function(e,t="https://data.id.tue.nl"){if(!e)return console.error("No api token provided!"),"No api token provided!";try{const o=await fetch(`${t}/v1/models`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),r=(await o.json()).data;return console.log("Models:",r),r}catch(e){console.error(e)}},fileSelector:async function(e,t=!0){document.querySelector("#df_hiddenFileInput")||(document.body.innerHTML+='<input type="file" id="df_hiddenFileInput" style="display: none;" onchange=""></input>'),"audio"===e||"sound"===e?document.querySelector("#df_hiddenFileInput").setAttribute("accept","audio/*"):"image"===e?document.querySelector("#df_hiddenFileInput").setAttribute("accept","image/*"):document.querySelector("#df_hiddenFileInput").removeAttribute("accept"),document.querySelector("#df_hiddenFileInput").click();try{return await new Promise(((e,o)=>{const r=document.querySelector("#df_hiddenFileInput");r?r.onchange=async function(r){const n=r.target.files;if(n&&n.length>0){const r=n[0];if(t&&console.log("File selected:",r),r.type.startsWith("image/"))try{let o=await foundry.processImage(r,t);e(o)}catch(e){o(new Error("Error during image processing"))}else e(r)}}:o(new Error("File input element not found"))}))}catch(e){console.error(e)}},transcribeRecording:async function({api_token:e,server:t,model:o,sliceDuration:r,resultElementSelector:n,loadingElementSelector:i,logging:a,stopRec:l}){return await foundry.soundToText({api_token:e,server:t,model:o,type:"record",sliceDuration:r,resultElementSelector:n,loadingElementSelector:i,logging:a,stopRec:l})},transcribeFile:async function({api_token:e,server:t,model:o,file:r,resultElementSelector:n,loadingElementSelector:i,logging:a}){return await foundry.soundToText({api_token:e,server:t,model:o,type:"file",file:r,resultElementSelector:n,loadingElementSelector:i,logging:a})},processImage:async function(e,t=!0){return new Promise(((t,r)=>{if(e instanceof File){const n=new FileReader;n.onload=function(e){const n=new Image;n.src=e.target.result,n.onload=async function(){let e=await o(n);t(e)},n.onerror=function(){r(new Error("Error loading image from file"))}},n.onerror=function(){r(new Error("Error reading the image file"))},n.readAsDataURL(e)}else if("string"==typeof e){const n=new Image;n.crossOrigin="Anonymous",n.src=e,n.onload=async function(){let e=await o(n);t(e)},n.onerror=function(){r(new Error("Error loading image from URL"))}}else r(new Error("Invalid image source"))}));function o(e){return new Promise((o=>{const r=document.createElement("canvas"),n=r.getContext("2d");let i=e.width,a=e.height;i>a?i>800&&(a*=800/i,i=800):a>800&&(i*=800/a,a=800),r.width=i,r.height=a,n.drawImage(e,0,0,i,a);const l=r.toDataURL("image/jpeg",.5);t&&console.log("Image processed."),o(l)}))}}};