const foundry={textToText:async function({api_token:e,model:o="hermes-2-pro-llama-3-8b",prompt:t,messages:n,temperature:r=.9,maxTokens:i=250,logging:a=!0,loadingElementSelector:c,resultElementSelector:l}){if(e){a&&console.log("Running text-to-text function"),n||(t||(console.error("No prompt given. Empty message created."),t=""),n=[{role:"user",content:t}]);try{c&&(document.querySelector(c)?document.querySelector(c).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const t=await fetch("https://data.id.tue.nl/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({messages:n,model:o,temperature:r,max_tokens:i})});let s=(await t.json()).choices[0].message.content;return a&&console.log("Result:",s),l&&(document.querySelector(l).innerHTML+=s),c&&(document.querySelector(c)?document.querySelector(c).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),s}catch(e){console.error("Error:",e)}}else console.error("No API key provided.")},textToImage:async function({api_token:e,prompt:o,temperature:t=.9,logging:n=!0,loadingElementSelector:r,resultElementSelector:i,steps:a=20,width:c=512,height:l=512}){if(n&&console.log("Running text-to-image function"),e)try{r&&(document.querySelector(r)?document.querySelector(r).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const s=await fetch("https://data.id.tue.nl/v1/images/generations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({prompt:o,steps:a,width:c,height:l,temperature:t})});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const d=await s.json();return n&&console.log("Generated image:",d.image_url),i&&(document.querySelector(i).src=d.image_url),r&&(document.querySelector(r)?document.querySelector(r).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),d.image_url}catch(e){console.error("There was a problem with the fetch operation:",e.message)}else console.error("No API key provided.")},textToSound:async function({api_token:e,projectId:o,prompt:t,language:n="en",loadingElementSelector:r,resultElementSelector:i,logging:a=!0}){if(e)if(o){a&&console.log("Running text-to-sound function"),r&&(document.querySelector(r)?document.querySelector(r).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));try{const c=await fetch(`https://data.id.tue.nl/api/vendor/t2s/${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({api_token:e,lang:n,text:t})}),l=await c.json(),s="https://data.id.tue.nl/api/vendor/t2s/"+l.text;return a&&console.log("Generated audio:",s),void 0===l.text&&console.error("No result. It is possible your API Key and project ID are not matching."),r&&(document.querySelector(r)?document.querySelector(r).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),i&&(document.querySelector(i).src=s),s}catch(e){console.error(e)}}else console.error("No project ID provided. Please find your project ID at the info section of your project.");else console.error("No API key provided.")},imageToText:async function({api_token:e,model:o="llava-llama-3-8b-v1_1",prompt:t,systemPrompt:n,image:r,temperature:i=.9,maxTokens:a=250,logging:c=!0,loadingElementSelector:l,resultElementSelector:s}){if(e){r||console.error("No image provided!"),c&&console.log("Running image-to-text function"),r=await foundry.processImage(r),messages=[{role:"system",content:n},{role:"user",content:[{type:"text",text:t},{type:"image_url",image_url:{url:r}}]}];try{l&&(document.querySelector(l)?document.querySelector(l).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const t=await fetch("https://data.id.tue.nl/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({messages:messages,model:o,temperature:i,max_tokens:a})});let n=(await t.json()).choices[0].message.content;return c&&console.log("Result:",n),s&&(document.querySelector(s).innerHTML+=n),l&&(document.querySelector(l)?document.querySelector(l).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),n}catch(e){console.error("Error:",e)}}else console.error("No API key provided.")},soundToText:async function({api_token:e,type:o="file",sliceDuration:t=5e3,file:n,resultElementSelector:r,loadingElementSelector:i,logging:a=!0,stopRec:c=!1}){if(c){return await async function(){return new Promise((o=>{recordAudio.stopRecording((async function(){var t=recordAudio.getBlob();let n="";e&&(n=await s({api_token:e,file:t,type:"file"}),r&&(document.querySelector(r).innerHTML+=n)),o(n)}))}))}()}if(!e)return void console.error("No API key provided.");let l="";if("record"===o&&function(e){if("undefined"!=typeof RecordRTC)a&&console.log("RecordRTC is already loaded."),e();else{a&&console.log("RecordRTC is not loaded, adding script to the page.");var o=document.createElement("script");o.src="https://cdn.webrtc-experiment.com/RecordRTC.js",o.async=!0,o.onload=function(){a&&console.log("RecordRTC has been loaded."),e()},document.head.appendChild(o)}}((function(){navigator.mediaDevices.getUserMedia({audio:!0}).then((function(o){recordAudio=RecordRTC(o,{type:"audio",mimeType:"audio/webm",sampleRate:44100,recorderType:StereoAudioRecorder,numberOfAudioChannels:1,desiredSampRate:16e3,timeSlice:t,disableLogs:!a,ondataavailable:async function(o){l+=await s({api_token:e,file:o}),a&&console.log("Transcription:",l),r&&(document.querySelector(r).innerHTML+=l)}}),recordAudio.startRecording()})).catch((e=>{console.error(`${e.name}: ${e.message}`)}))})),"file"===o)return await s({api_token:e,file:n});async function s({model:o="whisper-base",file:t}){const n=new FormData;n.append("model",o),n.append("file",t);try{i&&(document.querySelector(i)?document.querySelector(i).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const o=await fetch("https://data.id.tue.nl/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:n}),t=await o.json();return a&&console.log("Result:",t.text),i&&(document.querySelector(i)?document.querySelector(i).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),t.text}catch(e){console.error(e.message)}}},stopRec:async function({api_token:e,logging:o=!0,loadingElementSelector:t,resultElementSelector:n}){return e?await foundry.soundToText({api_token:e,stopRec:!0,logging:o,loadingElementSelector:t,resultElementSelector:n}):await foundry.soundToText({stopRec:!0,logging:o,loadingElementSelector:t,resultElementSelector:n})},models:async function(e){if(!e)return console.error("No api token provided!"),"No api token provided!";try{const o=await fetch("https://data.id.tue.nl/v1/models",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),t=(await o.json()).data;return console.log("Models:",t),t}catch(e){console.error(e)}},popup:async function(e,o=!0){document.querySelector("#df_hiddenFileInput")||(document.body.innerHTML+='<input type="file" id="df_hiddenFileInput" style="display: none;" onchange=""></input>'),"audio"===e||"sound"===e?document.querySelector("#df_hiddenFileInput").setAttribute("accept","audio/*"):"image"===e?document.querySelector("#df_hiddenFileInput").setAttribute("accept","image/*"):document.querySelector("#df_hiddenFileInput").removeAttribute("accept"),document.querySelector("#df_hiddenFileInput").click();try{return await new Promise(((e,t)=>{const n=document.querySelector("#df_hiddenFileInput");n?n.onchange=async function(n){const r=n.target.files;if(r&&r.length>0){const n=r[0];if(o&&console.log("File selected:",n),n.type.startsWith("image/"))try{let t=await foundry.processImage(n,o);e(t)}catch(e){t(new Error("Error during image processing"))}else e(n)}}:t(new Error("File input element not found"))}))}catch(e){console.error(e)}},processImage:async function(e,o=!0){return new Promise(((o,n)=>{if(e instanceof File){const r=new FileReader;r.onload=function(e){const r=new Image;r.src=e.target.result,r.onload=async function(){let e=await t(r);o(e)},r.onerror=function(){n(new Error("Error loading image from file"))}},r.onerror=function(){n(new Error("Error reading the image file"))},r.readAsDataURL(e)}else if("string"==typeof e){const r=new Image;r.crossOrigin="Anonymous",r.src=e,r.onload=async function(){let e=await t(r);o(e)},r.onerror=function(){n(new Error("Error loading image from URL"))}}else n(new Error("Invalid image source"))}));function t(e){return new Promise((t=>{const n=document.createElement("canvas"),r=n.getContext("2d");let i=e.width,a=e.height;i>a?i>800&&(a*=800/i,i=800):a>800&&(i*=800/a,a=800),n.width=i,n.height=a,r.drawImage(e,0,0,i,a);const c=n.toDataURL("image/jpeg",.5);o&&(console.log("Image processed."),console.log(c)),t(c)}))}}};