const foundry={textToText:async function({inputKey:e,model:t="hermes-2-pro-llama-3-8b",userPrompt:o,systemPrompt:n,temperature:r=.9,maxTokens:i=250,noLogging:s=!1,rememberMessages:a=0,loadingIndicatorId:c,resultElementId:l}){if(e){if(s||console.log("Running text-to-text function"),a){s||console.log("Chat history is active.");let e=`React to the message based on this message history: ${JSON.stringify(foundry.messageHistory)}. Latest message: ${o}`;messages=[{role:"system",content:n},{role:"user",content:e}]}else messages=[{role:"system",content:n},{role:"user",content:o}];try{c&&(document.getElementById(c)?document.getElementById(c).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const n=await fetch("https://data.id.tue.nl/v1/chat/completions",{method:"POST",cache:"no-cache",redirect:"manual",headers:{"Content-Type":"application/json","User-Agent":"curl/8.7.1",Authorization:`Bearer ${e}`},referrerPolicy:"no-referrer",body:JSON.stringify({key:"value",api_token:e,task:"chat",messages:messages,model:t,temperature:r,max_tokens:i})});let d=(await n.json()).choices[0].message.content;return s||console.log("Result:",d),l&&(document.getElementById(l).innerHTML=d),c&&(document.getElementById(c)?document.getElementById(c).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),a&&(foundry.messageHistory.push({role:"user",content:o},{role:"assistant",content:d}),foundry.messageHistory.length>a&&foundry.messageHistory.splice(0,2)),d}catch(e){console.error("Error:",e)}}else console.error("No API key provided.")},textToImage:async function({inputKey:e,userPrompt:t,temperature:o=.9,noLogging:n,loadingIndicatorId:r,resultElementId:i,steps:s=20,width:a=512,height:c=512}){if(n||console.log("Running text-to-image function"),e)try{r&&(document.getElementById(r)?document.getElementById(r).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const l=await fetch("https://data.id.tue.nl/v1/images/generations",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({prompt:t,steps:s,width:a,height:c,temperature:o})});if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const d=await l.json();return n||console.log("Generated image:",d.image_url),i&&(document.getElementById(i).src=d.image_url),r&&(document.getElementById(r)?document.getElementById(r).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),d.image_url}catch(e){console.error("There was a problem with the fetch operation:",e.message)}else console.error("No API key provided.")},textToSound:function(){console.log("Text to sound is currently not supported.")},imageToText:async function({inputKey:e,model:t="llava-llama-3-8b-v1_1",userPrompt:o,systemPrompt:n,image:r,popup:i=!1,temperature:s=.9,maxTokens:a=250,noLogging:c=!1,loadingIndicatorId:l,resultElementId:d}){if(e){if(c||console.log("Running image-to-text function"),i){document.getElementById("df_fileInput")||(document.body.innerHTML+='<input type="file" id="df_fileInput" accept="image/*" style="display: none;" onchange=""></input>'),document.getElementById("df_fileInput").click();try{r=await new Promise(((e,t)=>{const o=document.getElementById("df_fileInput");o?o.onchange=async function(o){const n=o.target.files;if(n&&n.length>0){const o=n[0];c||console.log("File selected:",o);try{r=await u(o),e(r)}catch(e){t(new Error("Error during image processing"))}}else t(new Error("No file selected"))}:t(new Error("File input element not found"))}))}catch(e){console.error("Error:",e.message)}}else r=await u(r);messages=[{role:"system",content:n},{role:"user",content:[{type:"text",text:o},{type:"image_url",image_url:{url:r}}]}];try{l&&(document.getElementById(l)?document.getElementById(l).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const o=await fetch("https://data.id.tue.nl/v1/chat/completions",{method:"POST",cache:"no-cache",redirect:"manual",headers:{"Content-Type":"application/json","User-Agent":"curl/8.7.1",Authorization:`Bearer ${e}`},referrerPolicy:"no-referrer",body:JSON.stringify({key:"value",api_token:e,task:"chat",messages:messages,model:t,temperature:s,max_tokens:a})});let n=(await o.json()).choices[0].message.content;return c||console.log("Result:",n),d&&(document.getElementById(d).innerHTML=n),l&&(document.getElementById(l)?document.getElementById(l).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),n}catch(e){console.error("Error:",e)}}else console.error("No API key provided.");function u(e){return new Promise(((t,o)=>{if(e instanceof File){const n=new FileReader;n.onload=function(e){const n=new Image;n.src=e.target.result,n.onload=function(){m(n).then(t)},n.onerror=function(){o(new Error("Error loading image from file"))}},n.onerror=function(){o(new Error("Error reading the image file"))},n.readAsDataURL(e)}else if("string"==typeof e){const n=new Image;n.crossOrigin="Anonymous",n.src=e,n.onload=function(){m(n).then(t)},n.onerror=function(){o(new Error("Error loading image from URL"))}}else o(new Error("Invalid image source"))}))}function m(e){return new Promise((t=>{const o=document.createElement("canvas"),n=o.getContext("2d");let r=e.width,i=e.height;r>i?r>800&&(i*=800/r,r=800):i>800&&(r*=800/i,i=800),o.width=r,o.height=i,n.drawImage(e,0,0,r,i);const s=o.toDataURL("image/jpeg",.5);c||console.log("Image processed."),t(s)}))}},soundToText:async function({inputKey:e,type:t="file",sliceDuration:o=5e3,file:n,resultElementId:r,loadingIndicatorId:i,noLogging:s,stopRec:a=!1}){if(!e)return void console.error("No API key provided.");if(a){return await async function(){return new Promise((t=>{recordAudio.stopRecording((async function(){var o=recordAudio.getBlob();let n=await l({inputKey:e,file:o,type:"file"});r&&(document.getElementById(r).innerHTML=n),t(n)}))}))}()}let c="";if("record"===t&&function(e){if("undefined"!=typeof RecordRTC)s||console.log("RecordRTC is already loaded."),e();else{s||console.log("RecordRTC is not loaded, adding script to the page.");var t=document.createElement("script");t.src="https://cdn.webrtc-experiment.com/RecordRTC.js",t.async=!0,t.onload=function(){s||console.log("RecordRTC has been loaded."),e()},document.head.appendChild(t)}}((function(){navigator.mediaDevices.getUserMedia({audio:!0}).then((function(t){recordAudio=RecordRTC(t,{type:"audio",mimeType:"audio/webm",sampleRate:44100,recorderType:StereoAudioRecorder,numberOfAudioChannels:1,desiredSampRate:16e3,timeSlice:o,disableLogs:s,ondataavailable:async function(t){c+=await l({inputKey:e,file:t}),s||console.log("Transcription:",c),r&&(document.getElementById(r).innerHTML=c)}}),recordAudio.startRecording()})).catch((e=>{console.error(`${e.name}: ${e.message}`)}))})),"popup"===t){document.getElementById("df_audioFileInput")||(document.body.innerHTML+='<input type="file" id="df_audioFileInput" accept="audio/*" style="display: none;" onchange=""></input>'),document.getElementById("df_audioFileInput").click();try{let t=await new Promise(((e,t)=>{const o=document.getElementById("df_audioFileInput");o?o.onchange=async function(o){const n=o.target.files;if(n&&n.length>0){const o=n[0];s||console.log("File selected:",o);try{e(o)}catch(e){t(new Error("Error during image processing"))}}else t(new Error("No file selected"))}:t(new Error("File input element not found"))}));return await l({inputKey:e,file:t})}catch(e){console.error("Error:",e.message)}}if("file"===t)return await l({inputKey:e,file:n});async function l({model:t="whisper-base",file:o}){const n=new FormData;n.append("model",t),n.append("file",o);try{i&&(document.getElementById(i)?document.getElementById(i).setAttribute("aria-busy","true"):console.error("Element selected for loading indicator not found"));const t=await fetch("https://data.id.tue.nl/v1/audio/transcriptions",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:n}),o=await t.json();return s||console.log("Result:",o.text),i&&(document.getElementById(i)?document.getElementById(i).setAttribute("aria-busy","false"):console.error("Element selected for loading indicator not found")),o.text}catch(e){console.error(e.message)}}},messageHistory:[]};